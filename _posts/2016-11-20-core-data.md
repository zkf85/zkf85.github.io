---
layout: post
title: "Core Data"
category: [iOS]
tags: [ios, core data, icloud, uimanageddocument]
---
<div class = "message">
"It's all about how core data works."
<br>KF 11/20/2016
</div>

## Database
Some times you need to store large amount of data or query it in a sophisticated manner. And we want it to be object-oriented.

Core data framework is very powerful.

## How does it work?
* Create a visual mapping between database and objects;
* Create and query for objects using object-oriented API;
* Access the "columns in the database table" using **@property**s on those objects.
* Create a core data model, the visual map in xcode.

## An Object Context
You need an `NSManagedObjectContext`.

It is the hub around which all Core Data activity turns.

### How do I get one?
There are two ways: 

1. Create a `UIMangedDocument` and ask for its `managedObjectContext` (a `@property`).
	
2. Click the "Use Core Data" button when you create a project (only works with certain templates, then you AppDelegate will have a managedObjectContext @property).

	There will be an `@property` and a method `saveContext` generated for managing the core data.
	
```objc
@property (readonly, strong) NSPersistentContainer *persistentContainer;
// The persistent container for the application. This implementation creates and returns a container, having loaded the store for the application to it.

- (void)saveContext;
```
We're going to focus on doing the first one `UIManagedDocument`.

## UIManagedDocument
`UIManagedDocument` inherits from UIDocument which provides a lot of mechanism for the management of storage. It also good for iCloud support. Think of a `UIManagedDocument` as simply a container for your Core Data database.

### 1. Create a UIManagedDocument
```swift
NSFileManager *fileManager = [NSFileManager defaultManager];  NSURL *documentsDirectory = [[fileManager URLsForDirectory:NSDocumentDirectory  inDomains:NSUserDomainMask] firstObject];
  NSString *documentName = @"MyDocument"; 
  NSURL *url = [documentsDirectory URLByAppendingPathComponent:documentName];UIManagedDocument *document = [[UIManagedDocument alloc] initWithFileURL:url];
```
This creates the UIManagedDocument instance, but does not open nor create the underlying file.

### 2. Open or Create a UIManagedDocument
Check if the `UIManagedDocument`'s underlying file exists on disk:

```swift
BOOL fileExists = [[NSFileManager defaultManager] fileExistsAtPath:[url path]]; 
```
Here is an example:

```objc
self.document = [[UIManagedDocument alloc] initWithFileURL:(URL *)url];
if ([[NSFileManager defaultManager] fileExistsAtPath:[url path]]) {
    [document openWithCompletionHandler:^(BOOL success) {
        if (success) [self documentIsReady];
        if (!success) NSLog(@"couldnâ€™t open document at %@", url);
    }];
} else {
    [document saveToURL:url forSaveOperation:UIDocumentSaveForCreating
      completionHandler:^(BOOL success) {
          if (success) [self documentIsReady];
          if (!success) NSLog(@"couldn't create document at %@", url);
      }];
}

- (void)documentIsReady {   if (self.document.documentState == UIDocumentStateNormal) { 
	// start using document
	NSManagedObjectContext *context = self.document.managedObjectContext;
   } 
}
```
### 3. Saving & Closing
* Notice that `UIManagedDocument`s AUTOSAVE themselves!
* Will automatically close if there are no strong pointers left to it.


<br>
***KF***